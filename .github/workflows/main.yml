name: Build & Deploy

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the dev branch
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  builddeploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # Runs a single command using the runners shell
      - name: Install dependencies
        run: npm install
        
      # Runs a single command using the runners shell
      - name: Build
        run: npm run build
        
      # Copies needed files to the build
      - name: Copy required files
        run: cp Procfile package.json dist
        
      # Move to build folder and generate zip
      - name: Generate deployment zip
        run: |
          cd dist
          zip -r deploy.zip *
        
      - name: Beanstalk Deploy
        uses: einaregilsson/beanstalk-deploy@v16
        with:
          # AWS Access Key
          aws_access_key: ${{secrets.AWS_ACCESS_KEY}}
          # AWS Secret Key
          aws_secret_key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          # AWS Region
          region: us-east-2
          # Beanstalk application name
          application_name: quidditch-manager-api
          # Beanstalk environment name. If empty a version will be created but not deployed anywhere.
          environment_name: qm-dev
          # Version label for new Beanstalk version
          version_label: 1
          # Version description for the new Beanstalk version
          # version_description: # optional
          # Zip file with the version to deploy. If skipped the action will deploy existing version.
          deployment_package: deploy.zip
          # If set to "true" then the action will deploy an existing version with the given version_label if it already exists, but otherwise create the version and deploy it.
          # use_existing_version_if_available: # optional
          # Whether the action should wait for the deployment to finish and log status messages during the wait. Default is "true". If set to "false" the action will start the deployment on Beanstalk and then exit.
          # wait_for_deployment: # optional
          # How many seconds to wait for the environment to return to Green state after deployment is finished. Default is 30 seconds.
          # wait_for_environment_recovery: # optional

      # Runs a set of commands using the runners shell
      #- name: Run a multi-line script
      #  run: |
      #    echo Add other actions to build,
      #    echo test, and deploy your project.
